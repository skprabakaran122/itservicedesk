=== PostgreSQL Authentication Fix ===

1. Stopping servicedesk service...

2. Checking PostgreSQL authentication configuration...
PostgreSQL version:  14.18 (Ubuntu 14.18-0ubuntu0.22.04.1)
Config directory: /etc/postgresql/ 14.18 (Ubuntu 14.18-0ubuntu0.22.04.1)/main

3. Backing up and updating pg_hba.conf...
cp: cannot stat '/etc/postgresql/ 14.18 (Ubuntu 14.18-0ubuntu0.22.04.1)/main/pg_hba.conf': No such file or directory
tee: '/etc/postgresql/ 14.18 (Ubuntu 14.18-0ubuntu0.22.04.1)/main/pg_hba.conf': No such file or directory
# PostgreSQL Client Authentication Configuration File

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             postgres                                peer
local   all             servicedesk                             md5
local   all             all                                     peer

# IPv4 local connections:
host    all             postgres        127.0.0.1/32            scram-sha-256
host    all             servicedesk     127.0.0.1/32            md5
host    all             all             127.0.0.1/32            scram-sha-256

# IPv6 local connections:
host    all             postgres        ::1/128                 scram-sha-256
host    all             servicedesk     ::1/128                 md5
host    all             all             ::1/128                 scram-sha-256

# Allow replication connections from localhost, by a user with the
# replication privilege.
local   replication     all                                     peer
host    replication     all             127.0.0.1/32            scram-sha-256
host    replication     all             ::1/128                 scram-sha-256

4. Reloading PostgreSQL configuration...

5. Recreating servicedesk user with proper authentication...
ERROR:  role "servicedesk" cannot be dropped because some objects depend on it
DETAIL:  owner of database servicedesk
23 objects in database servicedesk
ERROR:  role "servicedesk" already exists
You are now connected to database "servicedesk" as user "postgres".
GRANT
GRANT
ALTER SCHEMA
DO
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES

6. Testing authentication...
             status             | current_user | current_database
--------------------------------+--------------+------------------
 Authentication test successful | servicedesk  | servicedesk
(1 row)


7. Testing table access...
 table_name | count
------------+-------
 tickets    |     0
 changes    |     0
 users      |     0
(3 rows)


8. Verifying DATABASE_URL format...
Current DATABASE_URL:
DATABASE_URL=postgresql://servicedesk:servicedesk_password_2024@localhost:5432/servicedesk

9. Starting servicedesk with proper authentication...

10. Monitoring startup for 10 seconds...
Jun 17 12:29:43 ip-172-31-85-178 servicedesk[25668]: 12:29:43 PM [express] Warning: Failed to warm up database connection
Jun 17 12:29:43 ip-172-31-85-178 servicedesk[25668]: 12:29:43 PM [express] HTTP server running on port 5000 (host: 0.0.0.0)
Jun 17 12:29:43 ip-172-31-85-178 servicedesk[25668]: 12:29:43 PM [express] [AUTO-CLOSE] Error during auto-close process: error: permission denied for table tickets
Jun 17 12:29:43 ip-172-31-85-178 servicedesk[25668]: 12:29:43 PM [express] [OVERDUE] Error during overdue check process: error: permission denied for table changes

=== PostgreSQL Authentication Fix Complete ===

Authentication configuration updated
User permissions verified
Service restarted with proper database access
