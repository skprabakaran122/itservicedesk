
1. Stopping service...

2. Checking current database schema...
                                            Table "public.users"
      Column       |            Type             | Collation | Nullable |              Default
-------------------+-----------------------------+-----------+----------+-----------------------------------
 id                | integer                     |           | not null | nextval('users_id_seq'::regclass)
 username          | text                        |           | not null |
 email             | text                        |           | not null |
 password          | text                        |           | not null |
 role              | character varying(20)       |           | not null |
 name              | text                        |           | not null |
 assigned_products | text[]                      |           |          |
 created_at        | timestamp without time zone |           | not null | now()
Indexes:
    "users_pkey" PRIMARY KEY, btree (id)
    "users_email_unique" UNIQUE CONSTRAINT, btree (email)
    "users_username_unique" UNIQUE CONSTRAINT, btree (username)
Referenced by:
    TABLE "approval_routing" CONSTRAINT "approval_routing_approver_id_users_id_fk" FOREIGN KEY (approver_id) REFERENCES users(id)
    TABLE "change_approvals" CONSTRAINT "change_approvals_approver_id_users_id_fk" FOREIGN KEY (approver_id) REFERENCES users(id)
    TABLE "change_history" CONSTRAINT "change_history_user_id_users_id_fk" FOREIGN KEY (user_id) REFERENCES users(id)
    TABLE "ticket_history" CONSTRAINT "ticket_history_user_id_users_id_fk" FOREIGN KEY (user_id) REFERENCES users(id)


3. Running Drizzle schema migration...

> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/var/www/servicedesk/drizzle.config.ts'
Using 'pg' driver for database querying
[âœ“] Pulling schema from database...
[i] No changes detected

4. Verifying schema after migration...
                                            Table "public.users"
      Column       |            Type             | Collation | Nullable |              Default
-------------------+-----------------------------+-----------+----------+-----------------------------------
 id                | integer                     |           | not null | nextval('users_id_seq'::regclass)
 username          | text                        |           | not null |
 email             | text                        |           | not null |
 password          | text                        |           | not null |
 role              | character varying(20)       |           | not null |
 name              | text                        |           | not null |
 assigned_products | text[]                      |           |          |
 created_at        | timestamp without time zone |           | not null | now()
Indexes:
    "users_pkey" PRIMARY KEY, btree (id)
    "users_email_unique" UNIQUE CONSTRAINT, btree (email)
    "users_username_unique" UNIQUE CONSTRAINT, btree (username)
Referenced by:
    TABLE "approval_routing" CONSTRAINT "approval_routing_approver_id_users_id_fk" FOREIGN KEY (approver_id) REFERENCES users(id)
    TABLE "change_approvals" CONSTRAINT "change_approvals_approver_id_users_id_fk" FOREIGN KEY (approver_id) REFERENCES users(id)
    TABLE "change_history" CONSTRAINT "change_history_user_id_users_id_fk" FOREIGN KEY (user_id) REFERENCES users(id)
    TABLE "ticket_history" CONSTRAINT "ticket_history_user_id_users_id_fk" FOREIGN KEY (user_id) REFERENCES users(id)


5. Testing all table schemas...
                                               Table "public.tickets"
         Column          |            Type             | Collation | Nullable |               Default
-------------------------+-----------------------------+-----------+----------+-------------------------------------
 id                      | integer                     |           | not null | nextval('tickets_id_seq'::regclass)
 title                   | text                        |           | not null |
 description             | text                        |           | not null |
 status                  | character varying(20)       |           | not null |
 priority                | character varying(20)       |           | not null |
 category                | character varying(50)       |           | not null |
 product                 | character varying(100)      |           |          |
 assigned_to             | text                        |           |          |
 requester_id            | integer                     |           |          |
 requester_email         | text                        |           |          |
 requester_name          | text                        |           |          |
 requester_phone         | text                        |           |          |
 requester_department    | text                        |           |          |
 requester_business_unit | text                        |           |          |
 created_at              | timestamp without time zone |           | not null | now()
 updated_at              | timestamp without time zone |           | not null | now()
 first_response_at       | timestamp without time zone |           |          |
 resolved_at             | timestamp without time zone |           |          |
 sla_target_response     | integer                     |           |          |
 sla_target_resolution   | integer                     |           |          |
 sla_response_met        | character varying(10)       |           |          |
 sla_resolution_met      | character varying(10)       |           |          |
 approval_status         | character varying(20)       |           |          |
 approved_by             | text                        |           |          |
 approved_at             | timestamp without time zone |           |          |
 approval_comments       | text                        |           |          |
 approval_token          | text                        |           |          |
Indexes:
    "tickets_pkey" PRIMARY KEY, btree (id)
Referenced by:
    TABLE "attachments" CONSTRAINT "attachments_ticket_id_tickets_id_fk" FOREIGN KEY (ticket_id) REFERENCES tickets(id)
    TABLE "ticket_history" CONSTRAINT "ticket_history_ticket_id_tickets_id_fk" FOREIGN KEY (ticket_id) REFERENCES tickets(id)

                                                Table "public.changes"
          Column           |            Type             | Collation | Nullable |               Default
---------------------------+-----------------------------+-----------+----------+-------------------------------------
 id                        | integer                     |           | not null | nextval('changes_id_seq'::regclass)
 title                     | text                        |           | not null |
 description               | text                        |           | not null |
 status                    | character varying(20)       |           | not null |
 priority                  | character varying(20)       |           | not null |
 category                  | character varying(50)       |           | not null |
 product                   | character varying(100)      |           |          |
 requested_by              | text                        |           | not null |
 approved_by               | text                        |           |          |
 implemented_by            | text                        |           |          |
 planned_date              | timestamp without time zone |           |          |
 completed_date            | timestamp without time zone |           |          |
 start_date                | timestamp without time zone |           |          |
 end_date                  | timestamp without time zone |           |          |
 risk_level                | character varying(20)       |           | not null |
 change_type               | character varying(20)       |           | not null | 'normal'::character varying
 rollback_plan             | text                        |           |          |
 approval_token            | text                        |           |          |
 overdue_notification_sent | timestamp without time zone |           |          |
 is_overdue                | character varying(10)       |           |          | 'false'::character varying
 created_at                | timestamp without time zone |           | not null | now()
 updated_at                | timestamp without time zone |           | not null | now()
Indexes:
    "changes_pkey" PRIMARY KEY, btree (id)
Referenced by:
    TABLE "attachments" CONSTRAINT "attachments_change_id_changes_id_fk" FOREIGN KEY (change_id) REFERENCES changes(id)
    TABLE "change_approvals" CONSTRAINT "change_approvals_change_id_changes_id_fk" FOREIGN KEY (change_id) REFERENCES changes(id)
    TABLE "change_history" CONSTRAINT "change_history_change_id_changes_id_fk" FOREIGN KEY (change_id) REFERENCES changes(id)

                                            Table "public.users"
      Column       |            Type             | Collation | Nullable |              Default
-------------------+-----------------------------+-----------+----------+-----------------------------------
 id                | integer                     |           | not null | nextval('users_id_seq'::regclass)
 username          | text                        |           | not null |
 email             | text                        |           | not null |
 password          | text                        |           | not null |
 role              | character varying(20)       |           | not null |
 name              | text                        |           | not null |
 assigned_products | text[]                      |           |          |
 created_at        | timestamp without time zone |           | not null | now()
Indexes:
    "users_pkey" PRIMARY KEY, btree (id)
    "users_email_unique" UNIQUE CONSTRAINT, btree (email)
    "users_username_unique" UNIQUE CONSTRAINT, btree (username)
Referenced by:
    TABLE "approval_routing" CONSTRAINT "approval_routing_approver_id_users_id_fk" FOREIGN KEY (approver_id) REFERENCES users(id)
    TABLE "change_approvals" CONSTRAINT "change_approvals_approver_id_users_id_fk" FOREIGN KEY (approver_id) REFERENCES users(id)
    TABLE "change_history" CONSTRAINT "change_history_user_id_users_id_fk" FOREIGN KEY (user_id) REFERENCES users(id)
    TABLE "ticket_history" CONSTRAINT "ticket_history_user_id_users_id_fk" FOREIGN KEY (user_id) REFERENCES users(id)

                                         Table "public.products"
   Column    |            Type             | Collation | Nullable |               Default
-------------+-----------------------------+-----------+----------+--------------------------------------
 id          | integer                     |           | not null | nextval('products_id_seq'::regclass)
 name        | character varying(100)      |           | not null |
 category    | character varying(50)       |           | not null |
 description | text                        |           |          |
 is_active   | character varying(10)       |           | not null | 'true'::character varying
 created_at  | timestamp without time zone |           | not null | now()
 updated_at  | timestamp without time zone |           | not null | now()
Indexes:
    "products_pkey" PRIMARY KEY, btree (id)
    "products_name_unique" UNIQUE CONSTRAINT, btree (name)
Referenced by:
    TABLE "approval_routing" CONSTRAINT "approval_routing_product_id_products_id_fk" FOREIGN KEY (product_id) REFERENCES products(id)

                                           Table "public.attachments"
      Column      |            Type             | Collation | Nullable |                 Default
------------------+-----------------------------+-----------+----------+-----------------------------------------
 id               | integer                     |           | not null | nextval('attachments_id_seq'::regclass)
 file_name        | character varying(255)      |           | not null |
 original_name    | character varying(255)      |           | not null |
 file_size        | integer                     |           | not null |
 mime_type        | character varying(100)      |           | not null |
 file_content     | text                        |           |          |
 ticket_id        | integer                     |           |          |
 change_id        | integer                     |           |          |
 uploaded_by      | integer                     |           |          |
 uploaded_by_name | text                        |           |          |
 created_at       | timestamp without time zone |           | not null | now()
Indexes:
    "attachments_pkey" PRIMARY KEY, btree (id)
Foreign-key constraints:
    "attachments_change_id_changes_id_fk" FOREIGN KEY (change_id) REFERENCES changes(id)
    "attachments_ticket_id_tickets_id_fk" FOREIGN KEY (ticket_id) REFERENCES tickets(id)


6. Creating test data to verify full functionality...
ERROR:  column "hashedpassword" of relation "users" does not exist
LINE 1: INSERT INTO users (username, email, hashedPassword, role)
                                            ^
 username | email | role
----------+-------+------
(0 rows)

DELETE 0

7. Building application with updated schema...

> rest-express@1.0.0 build
> vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist

vite v5.4.19 building for production...
âœ“ 2185 modules transformed.
../dist/public/index.html                                        0.63 kB â”‚ gzip:   0.38 kB
../dist/public/assets/image_1749619432130-DAoAvPdR.png          62.92 kB
../dist/public/assets/index-BC726MWo.css                        92.92 kB â”‚ gzip:  14.83 kB
../dist/public/assets/anonymous-ticket-search-new-CqtgDTDz.js    7.62 kB â”‚ gzip:   2.28 kB
../dist/public/assets/anonymous-ticket-form-BOQj3JzE.js         11.15 kB â”‚ gzip:   3.63 kB
../dist/public/assets/calpion-rpa-project-form-D3LqY9lz.js      15.58 kB â”‚ gzip:   3.26 kB
../dist/public/assets/index-DePigBrC.js                        662.62 kB â”‚ gzip: 186.72 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
âœ“ built in 14.43s

  dist/index.js  144.8kb

âš¡ Done in 21ms

8. Starting service...

9. Monitoring for schema-related errors...
Jun 17 12:33:39 ip-172-31-85-178 servicedesk[25871]: 12:33:39 PM [express] Warning: Failed to warm up database connection
Jun 17 12:33:39 ip-172-31-85-178 servicedesk[25871]: 12:33:39 PM [express] HTTP server running on port 5000 (host: 0.0.0.0)
Jun 17 12:33:39 ip-172-31-85-178 servicedesk[25871]: 12:33:39 PM [express] [AUTO-CLOSE] Error during auto-close process: error: permission denied for table tickets
Jun 17 12:33:39 ip-172-31-85-178 servicedesk[25871]: 12:33:39 PM [express] [OVERDUE] Error during overdue check process: error: permission denied for table changes

